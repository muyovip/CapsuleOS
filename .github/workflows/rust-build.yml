name: Rust Engine CI/CD
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
env:
  GENESIS_API_URL: https://api.capsuleos.com
jobs:
  validate-rust:
    name: Validate Rust Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: clippy, rustfmt
      - name: Rust linting
        run: |
          cargo clippy -- -D warnings
          cargo fmt -- --check
      - name: GΛLYPH syntax validation
        run: |
          find . -name "*.glyph" -exec echo "Validating {}" \;
          find . -name "*.glyph" -exec cargo run --bin glyph_parser --validate {} \; || echo "No .glyph files to validate"
  build-wasm:
    name: Build Rust Engine & WASM
    runs-on: ubuntu-latest
    needs: validate-rust
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Install all crates
        run: cargo build --release
      - name: Build GΛLYPH parser
        run: cargo build --release --bin glyph_parser
      - name: Build WASM for web
        run: |
          cd glyph_parser
          wasm-pack build --target web --out-dir pkg/wasm --release
      - name: Validate WASM output
        run: |
          find . -name "*.wasm" -exec wasm-validate {} \;
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rust-artifacts
          path: |
            target/release/glyph_parser
            target/release/*.so
            glyph_parser/pkg/wasm/
  test-rust:
    name: Test Rust Components
    runs-on: ubuntu-latest
    needs: validate-rust
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Run unit tests
        run: cargo test --all-features --workspace
      - name: Run integration tests
        run: cargo test --test integration
      - name: Run Genesis Graph tests
        run: cargo test --package genesis_graph
      - name: Generate coverage report
        run: |
          cargo install cargo-tarpaulin
          cargo tarpaulin --out Xml --output-dir coverage
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: coverage/cobertura.xml
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: validate-rust
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Run security audit
        run: cargo audit
      - name: Check for vulnerable dependencies
        run: cargo-deny check || echo "cargo-deny not installed"
  build-release:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [test-rust, security-audit]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Build release binaries
        run: cargo build --release --target x86_64-unknown-linux-gnu
      - name: Create release archive
        run: |
          tar -czf capsuleos-rust-${{ github.sha }}.tar.gz \
            -C target/x86_64-unknown-linux-gnu/release \
            glyph_parser
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: capsuleos-rust-*.tar.gz
